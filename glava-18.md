# Глава 18. AGI

> _Кофеин. Шлюз к наркотикам._
>
> -- Эдди Веддер

Диалплан Asterisk превратился в простой, но мощный программный интерфейс для обработки вызовов. Однако многие люди, особенно с опытом программирования, предпочитают реализовывать обработку вызовов на традиционном языке программирования. Asterisk Gateway Interface (AGI) позволяет разрабатывать управление вызовами от первого лица на выбранном вами языке программирования.

## Быстрый старт

В этом разделе приведен краткий пример использования AGI.

Во-первых, давайте создадим скрипт, который мы собираемся запустить. Скрипты AGI как правило помещаются в _/var/lib/asterisk/agi-bin_.

```text
$ cd /var/lib/asterisk/agi-bin
$ vim hello-world.sh
#!/bin/bash
# Consume all variables sent by Asterisk
while read VAR && [ -n ${VAR} ] ; do : ; done
# Answer the call.
echo "ANSWER"
read RESPONSE
# Say the letters of "Hello World"
echo 'SAY ALPHA "Hello World" ""'
read RESPONSE
exit 0
$ chown asterisk:asterisk hello-world.sh
$ chmod 700 hello-world.sh
```

Теперь добавьте следующую строку в _/etc/asterisk/extensions.conf_ в контекст `[sets]`:

```text
exten => 237,1,AGI(hello-world.sh)
```

Сохраните и перезагрузите свой диалплан и теперь, когда вы звоните на номер 237, то должны услышать, как Эллисон произносит “Hello World.”

## Варианты AGI

Существует несколько вариантов AGI, которые отличаются в первую очередь методом, используемым для связи с Asterisk. Полезно быть в курсе всех вариантов для совершения лучшего выбора, основанного на потребностях вашего приложения.

### Process-Based AGI

Process-based AGI (AGI на основе процесса) является простейшим вариантом AGI. Пример быстрого запуска в начале этой главы является примером сценария Process-based AGI. Скрипт вызывается с помощью приложения `AGI()` из диалплана Asterisk. Запускаемое приложение указывается в качестве первого аргумента функции `AGI()`. Если не указан полный путь - приложение должно находиться в каталоге _/var/lib/asterisk/agi-bin_. Аргументы, передаваемые приложению AGI, могут быть указаны в качестве дополнительных аргументов приложения `AGI()` в диалплане Asterisk. Синтаксис такой:

```text
AGI(command[,arg1[,arg2[,...]]])
```

---

**Подсказка**

Убедитесь, что приложение имеет соответствующие разрешения на исполнение пользователем Asterisk. В противном случае функция `AGI()` завершится ошибкой.

---

Как только Asterisk выполнит ваше приложение AGI - связь между Asterisk и вашим приложением будет осуществляться через `stdin` и `stdout`. Более подробно об этом сообщении будет рассказано в разделе [“Обзор коммуникаций AGI”](glava-18.md#обзор-коммуникаций-agi). Для получения более подробной информации о вызове `AGI()` из диалплана проверьте документацию, встроенную в Asterisk:

```
*CLI> core show application AGI
```

**Плюсы Process-Based AGI (на основе процессов)**

Это самая простая форма реализации аги.

**Минусы Process-Based AGI**

Это наименее эффективная форма AGI с точки зрения потребления ресурсов. Вместо этого системы с высокой нагрузкой должны рассматривать FastAGI, описанный в разделе ["FastAGI - AGI через TCP"](glava-18.md#fastagi-agi-через-tcp).

#### EAGI

EAGI (Enhanced AGI - расширенный AGI) является легким вариантом `AGI()`. Он вызывается в диалплане Asterisk как `EAGI()`. Разница в том, что в дополнение к связи через `stdin` и `stdout` - Asterisk также обеспечивает однонаправленный аудиопоток, поступающий из канала на файловый дескриптор 3. Для получения более подробной информации о том, как вызвать `EAGI()` из диалплана Asterisk, проверьте документацию, встроенную в Asterisk:

```
*CLI> core show application EAGI
```

**Плюсы расширенного AGI**

Он проще Process-based AGI, включая канал аудиопотока только для чтения. Это единственный вариант, предлагающий эту функцию.

**Минусы расширенного AGI**

Поскольку для запуска приложения для каждого вызова необходимо создать новый процессь - он имеет те же проблемы эффективности, что и обычный, Process-Based AGI.

<table border="1" width="100%" cellpadding="5">
  <tr>
    <td>
      <p align="left"><b>Подсказка</b></p>
      <p>Для альтернативного способа получения доступа к аудио вне Asterisk - рассмотрите возможность использования <a href=https://jackaudio.org/>JACK</a>. Asterisk имеет модуль для интеграции JACK, называемый <code>app_jack</code>. Он предоставляет приложение <code>Jack()</code> и функцию диалплана <code>JACK_HOOK()</code>.</p>
    </td>
  </tr>
</table>

### FastAGI—AGI через TCP

_FastAGI_ - это термин, используемый для управления вызовами AGI через TCP-соединение. При использовании AGI на основе процессов экземпляр приложения AGI выполняется в системе для каждого вызова и связь с этим приложением осуществляется через `stdin` и `stdout`. С помощью FastAGI осуществляется TCP-соединение с сервером FastAGI. Управление вызовами осуществляется с использованием того же протокола AGI, но связь осуществляется через TCP-соединение и не требует запуска нового процесса для каждого вызова. Протокол AGI более подробно рассматривается в разделе ["Обзор коммуникаций AGI"](обзор-коммуникаций-agi). Использование FastAGI гораздо более масштабируемо, чем Process-Based AGI, хотя и более сложно в реализации.

Чтобы использовать FastAGI, вы вызываете приложение `AGI()` в диалплане Asterisk, но вместо имени приложения, которое нужно выполнить, вы предоставляете URL-адрес `agi://`. Например:

```
exten => 238,1,AGI(agi://127.0.0.1)
```

Номер порта по умолчанию для соединения FastAGI - `4573`. После двоеточия к URL-адресу можно добавить другой номер порта. Например:

```
exten => 238,1,AGI(agi://127.0.0.1:4574)
```

Так же, как и в случае AGI на основе процессов, в приложение FastAGI могут передаваться аргументы. Для этого добавьте их в качестве дополнительных аргументов в приложение `AGI()`, разделенных запятыми:

```
exten => 238,1,AGI(agi://192.168.1.199,arg1,arg2,arg3)
```

FastAGI также поддерживает использование записей DNS SRV, если вы предоставляете URL в виде `hagi://`. Используя записи SRV, DNS-серверы могут возвращать несколько узлов, к которым Asterisk может попытаться подключиться. Это может быть использовано для обеспечения высокой доступности и балансировки нагрузки. В следующем примере, для нахождения доступного для подключения сервера FastAGI, Asterisk выполнит поиск DNS для `_agi._tcp.shifteight.org`:

```
exten => 238,1,AGI(hagi://shifteight.org)
```

В этом примере DNS-сервера для домена `shifteight.org` потребуется хотя бы одна SRV-запись, настроенная для `_agi._tcp.shifteight.org`.

**Плюсы FastAGI**

Более эффективен чем process-based AGI. Вместо того, чтобы порождать новый процесс на вызов, можно построить сервер FastAGI для обработки нескольких вызовов.

DNS может использоваться для достижения высокой доступности и балансировки нагрузки между серверами FastAGI для дальнейшего повышения масштабируемости.

**Минусы FastAGI**

Он является более сложным при реализации сервера FastAGI, чем реализация приложения AGI на основе процессов.

### Асинхронный AGI - АМИ-контролируемый AGI

Async AGI позволяет приложению, использующему интерфейс AMI, асинхронно ставить команды AGI в очередь для выполнения на канале. Это может быть особенно полезно, если вы уже широко используете AMI и хотите улучшить свое приложение для обработки управления вызовами, а не писать подробный диалплан Asterisk или разрабатывать отдельный сервер FastAGI.

<table border="1" width="100%" cellpadding="5">
  <tr>
    <td>
      <p align="left"><b>Подсказка</b></p>
      <p>Дополнительную информацию об Asterisk Manager Interface можно найти в [Главе 17](glava-17.md#глава-17-ami-и-файлы-вызовов).</p>
    </td>
  </tr>
</table>

Асинхронный AGI вызывается приложением `AGI()` в диалплане Asterisk. Аргумент для `AGI()` должен быть `agi:async`, как показано в следующем примере:

```
exten => 239,AGI(agi:async)
```

Дополнительную информацию о том, как использовать асинхронный AGI через AMI, можно найти в следующем разделе.

**Плюсы асинхронного AGI**

Существующее приложение AMI можно использовать для управления вызовами с помощью команд AGI.

**Минусы асинхронного аги**

Это самый сложный способ реализации AGI.

<table border="1" width="100%" cellpadding="5">
  <tr>
    <td>
      <p align="center"><b>Настройка /etc/asterisk/manager.conf для асинхронного AGI</b></p>
      <p>Чтобы использовать асинхронный AGI, учетная запись AMI должна иметь разрешение <code>agi</code> как на <code>read</code>, так и на <code>write</code>. Например, следующий пользователь определенный в <i>manager.conf</i> будет иметь возможность как а) выполнять действия диспетчера AGI, так и б) получать события AGI:</p>
      <p><pre><code>
; Определите пользователя с именем "hello" и паролем "world".
; Предоставьте этому пользователю разрешения на чтение/запись для AGI.
;
[hello]
secret = world
read = agi
write = agi
      </code></pre></p>
    </td>
  </tr>
</table>

## Обзор коммуникаций AGI

В предыдущем разделе были рассмотрены возможные варианты использования AGI. Этот раздел содержит более подробные сведения о том, как ваше пользовательское приложение AGI взаимодействует с Asterisk после вызова функции `AGI()`.

### Настройка сеанса AGI

После вызова `AGI()` или `EAGI()` из диалплана Asterisk, в приложение AGI передается некоторая информация для настройки сеанса. В этом разделе рассматривается, какие шаги предпринимаются в начале сеанса AGI для различных вариантов.

#### AGI на основе процессов/FastAGI

Для приложения AGI на основе процессов или подключения к серверу FastAGI переменные, перечисленные в Таблице 18-1, будут первыми фрагментами информации, отправленными из Asterisk в ваше приложение. Каждая переменная будет находиться на своей собственной строке, в виде:

```
переменная_agi: значение
```

_Таблица 18-1. Переменные среды AGI_

| Переменная    | Значение/пример  | Описание |
| :------------ | :--------------- | :------- |
| `agi_request` | `hello-world.sh` | Первый аргумент, который был передан в приложение `AGI()` или `EAGI()`. Для process-based AGI - это имя выполненного приложения AGI. Для FastAGI это будет URL-адрес, использованный для подключения к серверу FastAGI. |
| `agi_channel` | `SIP/0004F2060EB4-00000009` | Имя канала, выполнившего команду приложения `AGI()` или `EAGI()`. |
| `agi_language` | `en` | Язык, установленный на `agi_channel`. |
| `agi_type` | `SIP` | Тип канала для `agi_channel`. |
| `agi_uniqueid` | `1284382003.9` | uniqueid для agi_channel. |
| `agi_version` | `1.8.0-beta4` | Используемая версия Asterisk. |
| `agi_callerid` | `12565551212` | Полная строка callerID, установленная на agi_channel. |
| `agi_calleridname` | `Russell Bryant` | Имя caller ID, установленное на agi_channel. |
| `agi_callingpres` | `0` | The caller presentation associated with the caller ID set on agi\_channel. For more information, see the output of core show function CALLERPRES at the Asterisk CLI. |
| `agi_callingani2` | `0` | The caller ANI2 associated with agi\_channel. |
| `agi_callington` | `0` | The caller ID TON \(Type of Number\) associated with agi\_channel. |
| `agi_callingtns` | `0` | The dialed number TNS \(Transit Network Select\) associated with agi\_channel. |
| `agi_dnid` | `7010` | The dialed number associated with agi\_channel. |
| `agi_rdnis` | `unknown` | The redirecting number associated with agi\_channel. |
| `agi_context` | `phones` | The context of the dialplan that agi\_channel was in when it executed the AGI\(\) or EAGI\(\) application. |
| `agi_extension` | `500` | The extension in the dialplan that agi\_channel was executing when it ran the AGI\(\) or EAGI\(\) application. |
| `agi_priority` | `1` | The priority of agi\_extension in agi\_context that executed AGI\(\) or EAGI\(\). |
| `agi_enhanced` | `0.0` | An indication of whether AGI\(\) or EAGI\(\) was used from the dialplan. 0.0 indicates that AGI\(\) was used. 1.0 indicates that EAGI() was used. |
| `agi_accountcode` | `myaccount` | The accountcode associated with agi\_channel. |
| `agi_threadid` | `140071216785168` | The threadid of the thread in Asterisk that is running the AGI\(\) or EAGI\(\) application. This may be useful for associating logs generated by the AGI application with logs generated by Asterisk, since the Asterisk logs contain thread IDs. |
| `agi_arg_<argument number>` | `my argument` | These variables provide the contents of the additional arguments provided to the AGI\(\) or EAGI() application. |


agi_language
en

Язык, установленный на agi_channel.

agi_type


ПРИХЛЕБЫВАТЬ


Тип канала для: agi_channel.

agi_uniqueid


1284382003.9


То uniqueid от agi_channel.

agi_version


1.8.0-beta4


Используемая версия Asterisk.

agi_callerid


12565551212


Полная строка идентификатора вызывающего абонента, которая установлена на agi_channel.

agi_calleridname


Рассел Брайант


Имя идентификатора вызывающего абонента, которое установлено на agi_channel.

agi_callingpres


0


Представление вызывающего абонента, связанное с установленным идентификатором вызывающего абонента agi_channel. Для получения дополнительной информации см. выходные данные ядро показывает функцию CALLERPRES на CLI звездочки.

agi_callingani2


0


Вызывающий объект ANI2, связанный с agi_channel.

agi_callington


0


Тонна идентификатора вызывающего абонента (тип номера), связанная с agi_channel.

agi_callingtns


0


Набранный номер TNS (выбор транзитной сети), связанный с agi_channel.

agi_dnid


7010


Набранный номер, связанный с agi_channel.

agi_rdnis


неизвестный


Номер перенаправления, связанный с agi_channel.

agi_context


телефоны


Контекст диалплана, который agi_channel был там, когда его казнили АГИ() или EAGI() приложение.

agi_extension


500


Добавочный номер в диалплане, который agi_channel был исполнен, когда он запустил АГИ() или EAGI() приложение.

agi_priority


1


Приоритетное направление деятельности agi_extension в agi_context что исполнено АГИ() или EAGI().

agi_enhanced


0.0


Указание на то, есть ли АГИ() или EAGI() был использован из диалплана. 0.0 свидетельствовать о том АГИ() был используемый. 1.0 свидетельствовать о том EAGI() был используемый.

agi_accountcode


myaccount


То код счета общаться agi_channel.

agi_threadid


140071216785168


То threadid из потока в звездочке, на котором выполняется АГИ() или EAGI() приложение. Это может быть полезно для связывания журналов, созданных приложением AGI, с журналами, созданными Asterisk, поскольку журналы Asterisk содержат идентификаторы потоков.

agi_arg_<номер аргумента>


мой аргумент


Эти переменные предоставляют содержимое дополнительных аргументов, предоставленных пользователю АГИ() или EAGI() приложение.

Пример переменных, которые могут быть отправлены в приложение учи, см. В разделе выходные данные отладки связи учи в разделе "быстрый запуск". Конец списка переменных будет обозначен пустой строкой. Код обрабатывает эти переменные путем считывания строк ввода в цикле, пока не будет получена пустая строка. В этот момент приложение продолжает и начинает выполнять команды AGI.
Асинхронный учи

При использовании асинхронного AGI, Asterisk будет отправлять событие диспетчера называется AsyncAGI чтобы инициировать сеанс асинхронного учи. Это событие позволит приложениям, прослушивающим события диспетчера, взять на себя управление вызовом с помощью действия AGI manager. Вот пример события диспетчера, отправленного Asterisk:

Событие: AsyncAGI

Привилегия: аги, все

SubEvent: Начало

Канал: SIP / 0000FFFF0001-00000000

Env: agi_request%3A%20async%0Aagi_channel%3A%20SIP%2F0000FFFF0001-00000000%0A \

agi_language%3A%20en%0Aagi_type%3A%20SIP%0A \

agi_uniqueid%3A%201285219743.0%0A \

agi_version%3A%201.8.0-beta5%0Aagi_callerid%3A%2012565551111%0A \

agi_calleridname%3A%20Julie%20Bryant%0Aagi_callingpres%3A % 200%0A \

agi_callingani2%3a%200% 0Aagi_callington%3A%200%0Aagi_callingtns%3A%200% 0A \

agi_dnid%3A%20111%0aagi_rddnis%3A%20unknown%0Aagi_context%3A%20LocalSets%0A \

agi_extension%3A%20111%0Aagi_priority%3A%201%0Aagi_enhanced%3A % 200.0%0A \

agi_accountcode%3A%20%0Aagi_threadid%3A%20-1339524208%0A%0A
Примечание

Значение самого Env заголовок в этом AsyncAGI событие менеджера находится все на одной линии. Длиннее значение the Env заголовок был закодирован URI.
Команды и ответы

После настройки сеанса учи Asterisk начинает выполнять обработку вызовов в ответ на команды, отправленные из приложения учи. Как только команда AGI будет выдана Asterisk, никакие другие команды не будут обработаны на этом канале, пока текущая команда не будет завершена. Когда он закончит обработку команды, Asterisk ответит с результатом.
Примечание

Учи обрабатывает команды последовательно. После выполнения команды никакие другие команды не могут быть выполнены до тех пор, пока Asterisk не вернет ответ. Некоторые команды могут выполняться очень долго. Например, в ВЫПОЛНЕНИЕ Команда AGI выполняет приложение Asterisk. Если команда есть EXEC Dial, Связь с учи блокируется до тех пор, пока вызов не будет выполнен. Если на данном этапе вашему приложению AGI необходимо продолжить взаимодействие со Asterisk, оно может сделать это с помощью AMI, который рассматривается в главе 17 .

Вы можете получить полный список доступных команд AGI из консоли Asterisk, выполнив эту команду команды показа учи. Эти команды описаны в таблице 18-2 . Для получения более подробной информации о конкретной команде AGI, включая сведения о синтаксисе для всех ожидаемых аргументов, используйте agi показать команды тема Командование . Например, чтобы Просмотреть встроенную документацию для ОТВЕТ Команда учи, вы бы использовали agi показать команды тема ответ.


Таблица 18-2. Команды учи

Команда учи


Описание

ОТВЕТ


Ответьте на входящий вызов.

ASYNCAGI ПЕРЕРЫВ


Завершите сеанс асинхронного AGI и верните канал в план набора номера Asterisk.

КАНАЛ СТАТУС


Получите статус канала. Это используется для получения текущего состояния канала, такого как up (ответ), down (hung up) или ringing.

БАЗА ДАННЫХ DEL


Удалите пару ключ / значение из встроенной базы данных AstDB.

БАЗА ДАННЫХ DELTREE


Удалите дерево пар ключ / значение из встроенной базы данных AstDB.

БАЗА ДАННЫХ GET


Извлеките значение для ключа в базе данных AstDB.

БАЗА ДАННЫХ PUT


Установите значение для ключа в базе данных AstDB.

ВЫПОЛНЕНИЕ


Выполните приложение Asterisk dialplan на канале. Эта команда очень сильна в том, что между ВЫПОЛНЕНИЕ и ПОЛУЧИТЬ ПОЛНУЮ ПЕРЕМЕННУЮ, вы можете сделать все, что угодно с вызовом, который вы можете сделать из плана набора номера Asterisk.

ПОЛУЧИТЬ ДАННЫЕ


Считывание цифр с вызывающего абонента.

ПОЛУЧИТЬ ПОЛНЫЙ ПЕРЕМЕННАЯ


Оцените выражение диалплана звездочки. Вы можете отправить строку, содержащую переменные и / или функции dialplan, и Asterisk вернет результат после выполнения соответствующих подстановок. Эта команда очень сильна в том, что между ВЫПОЛНЕНИЕ и ПОЛУЧИТЬ ПОЛНУЮ ПЕРЕМЕННУЮ, вы можете сделать все, что угодно с вызовом, который вы можете сделать из плана набора номера Asterisk.

ПОЛУЧИТЬ ОПЦИЮ


Потоковая передача звукового файла во время ожидания цифры от вызывающего абонента. Это похоже на то, что Фон() приложение dialplan.

ПОЛУЧИТЬ ПЕРЕМЕННУЮ


Извлеките значение переменной канала.

ЗАВИСАНИЕ


Повесь трубку на рычаг.один

Не-А ...


Ничего не делать. Вы получите ответ результата от этой команды, как и любой другой. Он может быть использован в качестве простого теста пути связи со звездочкой.

ПОЛУЧИТЬ ЧАР


Получите один символ. Это работает только для типов каналов, которые его поддерживают, таких как iax2 using ТЕКСТ рамки или глоток используя СООБЩЕНИЕ метод.

ПОЛУЧЕНИЕ ТЕКСТА


Получите текстовое сообщение. Это работает только в тех же случаях, что и ПОЛУЧИТЬ ЧАР.

ФАЙЛ ЗАПИСИ


Запись аудио от вызывающего абонента в файл. Это блокирующая операция, аналогичная той Запись() приложение dialplan. Чтобы записать вызов в фоновом режиме во время выполнения других операций, используйте ВЫПОЛНЕНИЕ Монитор или EXEC MixMonitor.

СКАЖИ АЛЬФА


Скажем, строку символов. Вы можете найти пример этого в разделе "Быстрый старт". Чтобы получить локализованную обработку этого и другого СКАЗАТЬ команды, устанавливающие язык канала либо в файле конфигурации устройства (например, sip.conf ) или в dialplan, установив Канал(язык) функция dialplan.

СКАЖЕМ ЦИФРЫ


Скажем, строку цифр. Например, 100 будет сказано как "один ноль ноль", если язык канала установлен на английском языке.

СКАЖИ ЧИСЛО


Скажи номер телефона. Например, 100 будет сказано как "сто", если язык канала установлен на английский язык.

ГОВОРЯТ ФОНЕТИЧЕСКИ


Произнесите строку символов, но используйте общее слово для каждой буквы (Альфа, Браво, Чарли...).

СКАЖИ ДАТУ


Скажем, заданную дату.

СКАЖИ ВРЕМЯ


Скажем, в определенное время.

СКАЖЕМ DATETIME


Скажите заданную дату и время, используя указанный формат.

ОТПРАВИТЬ ИЗОБРАЖЕНИЕ


Отправить изображение на канал. IAX2 поддерживает это, но нет никаких активно разработанных клиентов IAX2, которые поддерживают его, о которых мы знаем.

ОТПРАВИТЬ ТЕКСТ


Отправьте текст на канал, который его поддерживает. Это может быть использовано с каналами SIP и IAX2, по крайней мере.

УСТАНОВИТЕ AUTOHANGUP


Запланируйте канал, который будет отключен в указанный момент времени в будущем.

УСТАНОВИТЬ CALLERID


Установите имя и номер идентификатора вызывающего абонента на канале.

УСТАНОВИТЬ КОНТЕКСТ


Установите текущий контекст dialplan на канале.

УСТАНОВИТЬ РАСШИРЕНИЕ


Установите текущее расширение dialplan на канале.

УСТАНОВИТЬ МУЗЫКУ


Запуск или остановка музыки на удержание на канале.

РАССТАВЛЯТЬ ПРИОРИТЕТЫ


Установите текущий приоритет dialplan на канале.

УСТАНОВИТЬ ПЕРЕМЕННУЮ


Задайте для переменной канала заданное значение.

ПОТОКОВЫЙ ФАЙЛ


Потоковая передача содержимого файла в канал.

ФАЙЛ ПОТОКА УПРАВЛЕНИЯ


Передайте содержимое файла в канал, но также позвольте каналу управлять потоком. Например, канал может приостановить, перемотать назад или перемотать вперед поток.

РЕЖИМ TDD


Переключите режим TDD (Telecommunications Device for the Deaf)на канале.

МНОГОСЛОВНЫЙ


Отправьте сообщение на канал verbose logger. Подробные сообщения отображаются на консоли Asterisk, если значение параметра verbose достаточно высокое. Подробные сообщения также будут отправляться в любой файл журнала, настроенный для многословный канал регистратора в /etc / asterisk / logger.conf.

ДОЖДИТЕСЬ ЦИФРЫ


Дождитесь, пока вызывающий абонент нажмет цифру.

СОЗДАНИЕ РЕЧИ


Инициализируйте распознавание речи. Это необходимо сделать перед использованием других речевых команд AGI.б

РЕЧЕВОЙ НАБОР


Установите настройку речевого движка. Доступные настройки относятся только к используемому механизму распознавания речи.

РЕЧЬ УНИЧТОЖИТЬ


Уничтожьте ресурсы, которые были выделены для выполнения распознавания речи. Эта команда должна быть последней выполненной речевой командой.

РЕЧЬ ЗАГРУЖАТЬ ГРАММАТИКА


Загрузите грамматику.

РЕЧЕВАЯ РАЗГРУЗКА ГРАММАТИКА


Выгрузите грамматику.

РЕЧЬ АКТИВИРОВАТЬ ГРАММАТИКА


Активируйте грамматику, которая была загружена.

РЕЧЬ ДЕЗАКТИВИРОВАТЬ ГРАММАТИКА


Деактивируйте грамматику.

РЕЧЬ РАСПОЗНАВАТЬ


Воспроизводите запрос и выполняйте распознавание речи, а также ждите нажатия цифр.

GOSUB


Выполните функцию dialplan. Это будет выполняться так же, как и GoSub() приложение dialplan.

один Когда ЗАВИСАНИЕ Используется команда AGI, канал не сразу отключается. Вместо этого канал помечается как нуждающийся в отключении. Ваше приложение учи должно выйти первым, прежде чем Asterisk продолжит и выполнит фактический процесс зависания.

б Хотя Asterisk включает в себя основной API для обработки распознавания речи,он не поставляется с модулем, который обеспечивает механизм распознавания речи. В настоящее время Digium предоставляет два коммерческих варианта распознавания речи: Lumenvox и Vestec .
Аги на основе процессов / FastAGI

Команды AGI отправляются на Asterisk в одной строке. Строка должна заканчиваться одним символом новой строки. После отправки команды на Asterisk дальнейшие команды не будут обрабатываться до тех пор, пока последняя команда не будет завершена и ответ не будет отправлен обратно в приложение AGI. Вот пример ответа на команду AGI:

200 результат=0
Совет

Консоль Asterisk позволяет отлаживать взаимодействие с приложением AGI. Чтобы включить отладку связи AGI, выполните следующие действия: agi set debug on команда. Чтобы отключить отладку, используйте agi set debug off. Пока этот режим отладки включен, вся связь с приложением учи и из него будет распечатана на консоли Asterisk. Пример такого вывода можно найти в разделе “быстрый запуск” .
Асинхронный учи

При использовании асинхронного учи можно выполнять команды с помощью действия диспетчера учи. Чтобы Просмотреть встроенную документацию для действия AGI manager, выполните менеджер показать команду AGI на CLI звездочки. Демонстрация поможет выяснить, как выполняются команды учи с помощью метода асинхронного учи. Во-первых, расширение создается в dialplan, который выполняет сеанс асинхронного учи на канале:

exten = > 240, AGI(agi:async)

При выполнении приложения AGI dialplan вызывается событие диспетчера AsyncAGI будут отправлены вместе со всеми переменными среды AGI. Подробная информация об этом событии находится в разделе “асинхронный учи” . После этого действия менеджера учи могут начать выполняться через AMI.

Ниже приведен пример выполнения действия диспетчера и события диспетчера, которые генерируются во время асинхронной обработки AGI. После первоначального выполнения программы АГИ действие диспетчера, есть немедленный ответ, чтобы указать, что команда была помещена в очередь для выполнения. Позже появляется событие диспетчера, которое указывает, что команда queued была выполнена. То CommandID заголовок можно использовать для связывания начального запроса с событием, которое указывает на то, что команда была выполнена:

Действие: учи

Канал: SIP / 0004F2060EB4-00000013

ActionID: my-action-id

CommandID: my-command-id

Команда: многословные " щенки любят сахарную вату." 1


Ответ: Успех

ActionID: my-action-id

Сообщение: добавлена команда AGI для очереди


Событие: AsyncAGI

Привилегия: аги, все

SubEvent: Exec

Канал: SIP / 0004F2060EB4-00000013

CommandID: my-command-id

Результат: 200% 20result%3D1%0A

Следующие выходные данные-это то, что было замечено на консоли Asterisk во время этого асинхронного сеанса AGI:

-- Выполнение [7011@phones:1] учи ("SIP / 0004F2060EB4-00000013",

"agi:async") в новом стеке

аги: асинхронность: щенки любят сладкую вату.

= = Spawn extension (телефоны, 7011, 1)

вышел ненулевым на 'SIP / 0004F2060EB4-00000013'
Завершение сеанса учи

Сеанс учи завершается, когда приложение учи готово к его завершению. Подробности о том, как это происходит, зависят от того, использует ли ваше приложение process-based AGI, FastAGI или async AGI.
Аги на основе процессов / FastAGI

Ваше приложение учи может выйти или закрыть свое соединение в любое время. Если канал не был отключен до завершения работы приложения, выполнение dialplan будет продолжено.

Если отключение канала происходит, пока ваш сеанс учи все еще активен, Asterisk предоставит уведомление о том, что это произошло, чтобы ваше приложение могло соответствующим образом настроить свою работу.

Если канал зависает, пока ваше приложение учи все еще выполняется, произойдет несколько вещей. Если команда AGI находится в середине выполнения, вы можете получить код результата -1. Однако вы не должны зависеть от этого, поскольку не все команды AGI требуют взаимодействия с каналом. Если выполняемая команда не требует взаимодействия с каналом, результат не будет отражать зависание.

Следующее, что происходит после того, как канал зависает, это то, что явное уведомление о зависании отправляется в ваше приложение. Для процесса на основе учи, сигнал Вздох ... будет отправлен в процесс, чтобы уведомить его о зависании. Для быстрого подключения Asterisk отправит строку, содержащую слово ЗАВИСАНИЕ.

Если вы хотите отключить функцию отправки звездочек, то Вздох ... сигнал для вашего приложения AGI на основе процесса или ЗАВИСАНИЕ строка для вашего сервера FastAGI, вы можете сделать это, установив AGISIGHUP переменная канала, как показано в этом коротком примере:

; нет вздоха (учи) или повесить трубку (Фастаги)

exten = > 237,1, Set(AGISIGHUP=нет)

same = > n, AGI(hello-world.sh)

После того, как зависание произошло, единственные команды AGI, которые могут использоваться, являются теми, которые не требуют взаимодействия канала. Документация для команд учи, встроенных в Asterisk, включает указание на то, можно ли использовать каждую команду после того, как канал был отключен.
Асинхронный учи

При использовании асинхронного AGI интерфейс диспетчера предоставляет механизмы для уведомления о зависаниях канала. Если вы хотите завершить сеанс асинхронного учи для канала, необходимо выполнить следующее ASYNCAGI ПЕРЕРЫВ команда. Когда сеанс асинхронного учи закончится, Asterisk отправит сообщение AsyncAGI событие менеджера с a Подэволюция от Конец. Ниже приведен пример завершения асинхронного сеанса AGI:

Действие: учи

Канал: SIP / 0004F2060EB4-0000001b

ActionID: my-action-id

CommandID: my-command-id

Команда: ASYNCAGI перерыв


Ответ: Успех

ActionID: my-action-id

Сообщение: добавлена команда AGI для очереди


Событие: AsyncAGI

Привилегия: аги, все

SubEvent: Конец

Канал: SIP / 0004F2060EB4-0000001b

На этом этапе канал возвращается к следующему шагу в плане набора номера Asterisk (если он еще не был отключен).
Пример: Доступ К Базе Данных Учетной Записи

Пример 18-1 - это пример сценария учи. Чтобы запустить этот скрипт, вы сначала поместите его в каталог /var/lib/asterisk/agi-bin. Тогда вы бы выполнили его из диалплана Asterisk вот так:

exten = > 241,1, AGI(account-lookup.py)

то же самое = > n, отбой()

Этот пример написан на Python и очень скудно документирован для краткости. Это демонстрирует, как сценарий AGI взаимодействует со звездочкой с помощью стандартный ввод и стандартный вывод.

Сценарий предлагает пользователю ввести номер учетной записи, а затем воспроизводит значение, связанное с этим номером. В интересах краткости, мы жестко закодировали несколько поддельных учетных записей в скрипт—это, очевидно, будет что-то нормально обрабатываемое подключением к базе данных.

Сценарий намеренно лаконичен, так как мы заинтересованы в кратком показе некоторых функций учи, не заполняя эту книгу страницами кода.
Пример 18-1. account-lookup.py

#!/usr / bin / env python

# Пример для AGI (Asterisk Gateway Interface).


импортировать sys


защита agi_command(cmd):

"Выпишите команду и верните ответ"

Печать УМК

sys.стандартный вывод.промывать() #очистить буфер

Возврат sys.стандартный ввод.readline ().Стриптиз() # полоса пробелов


asterisk_env = {} # read AGI env vars from Asterisk

в то время как Правда:

линия = sys.стандартный ввод.readline ().Стриптиз()

если нет лен (линия):

ломать

var_name, var_value = линия.расщеплять':'(, 1)

asterisk_env[var_name] = var_value


# Поддельные "базы данных" учетных записей.

СЧЕТА = {

'12345678': {"баланс": '50'},

'11223344': {"баланс": '10'},

'87654321': {"баланс": '100'},

}


ответ = agi_command ('ответ')


# три аргумента: приглашение, тайм-аут, maxlength

ответ = agi_command ('GET DATA enter_account 3000 8')


если 'timeout' в ответ:

ответ = agi_command ('STREAM FILE goodbye""')

sys.выход(0)


# Ответ будет выглядеть так: 200 результат= < цифры>

# Split on'=', нам нужен индекс 1

Учетная запись = ответ.расщеплять'='(, 1)[1]


если Учетная запись == '-1': # цифры, если ошибка

ответ = agi_command ('STREAM FILE astcc-account-number-invalid ""')

ответ = agi_command ('HANGUP')

sys.выход(0)


если Учетная запись нет в СЧЕТА: # недействительный

ответ = agi_command ('STREAM FILE astcc-account-number-invalid ""')

sys.выход(0)


баланс = Счета[account] ['balance']


ответ = agi_command ('STREAM FILE account-balance-is "")

ответ = agi_command ('SAY NUMBER %s ""' % (баланс))

sys.выход(0)
рамки развития

Был предпринят ряд усилий по созданию фреймворков или библиотек, облегчающих Программирование учи. Вы заметите, что некоторые из этих рамок также появились в главе 17 . Так же, как и в случае с AMI, при оценке фреймворка мы рекомендуем вам найти тот, который соответствует следующим критериям:

Зрелость

Этот проект существует уже несколько лет? Зрелый проект гораздо менее вероятно будет иметь серьезные ошибки в нем.

Поддержка

Проверьте возраст последнего обновления. Если проект не был обновлен в течение нескольких лет, есть большая вероятность, что он был заброшен. Он все еще может быть полезен, но вы будете сами по себе. Аналогично, как выглядит трекер ошибок? Есть ли много важных ошибок, которые игнорируются? (Будьте проницательны здесь, так как часто реалии поддержания свободного проекта требуют дисциплинированного сортировки—не все функции будут добавлены.)

Качество кода

Это хорошо написанная структура? Если он не был спроектирован хорошо, вы должны знать об этом, решая, стоит ли доверять ему свой проект.

Сообщество

Есть ли активное сообщество разработчиков, использующих этот проект? Скорее всего, вам понадобится помощь; будет ли она доступна, когда вы в ней нуждаетесь?

Документация

Код должен быть хорошо прокомментирован, но в идеале, вики или другая официальная документация для поддержки библиотеки имеет важное значение.

На момент подготовки настоящего документа рамки, перечисленные в таблице 18-3, удовлетворяли всем или большинству из приведенных выше критериев. Если вы не видите здесь библиотеку для вашего предпочтительного языка программирования, она может быть где-то там, но просто не попала в наш список.
## AGI Communication Overview

The preceding section discussed the variations of AGI that can be used. This section goes into more detail about how your custom AGI application communicates with Asterisk once AGI() has been invoked.

### Setting Up an AGI Session

Once AGI() or EAGI() has been invoked from the Asterisk dialplan, some information is passed to the AGI application to set up the AGI session. This section discusses what steps are taken at the beginning of an AGI session for the different variants of AGI.

#### Process-based AGI/FastAGI

For a process-based AGI application or a connection to a FastAGI server, the variables listed in [Table 18-1](18.%20Asterisk%20Gateway%20Interface%20-%20Asterisk%20%20The%20Definitive%20Guide,%205th%20Edition.htm%22%20/l%20%22AGI-variables) will be the first pieces of information sent from Asterisk to your application. Each variable will be on its own line, in the form:

agi_variable: value

Table 18-1. AGI environment variables

| Variable | Value/example | Description |
| :--- | :--- | :--- |
| `agi_request` | hello-world.sh | The first argument that was passed to the AGI\(\) or EAGI\(\) application. For process-based AGI, this is the name of the AGI application that has been executed. For FastAGI, this would be the URL that was used to reach the FastAGI server. |
| `agi_channel` | SIP/0004F2060EB4-00000009 | The name of the channel that has executed the AGI\(\) or EAGI\(\) application. |
| `agi_language` | en | The language set on agi\_channel. |
| `agi_type` | SIP | The channel type for agi\_channel. |
| `agi_uniqueid` | 1284382003.9 | The uniqueid of agi\_channel. |
| `agi_version` | 1.8.0-beta4 | The Asterisk version in use. |
| `agi_callerid` | 12565551212 | The full caller ID string that is set on agi\_channel. |
| `agi_calleridname` | Russell Bryant | The caller ID name that is set on agi\_channel. |
| `agi_callingpres` | 0 | The caller presentation associated with the caller ID set on agi\_channel. For more information, see the output of core show function CALLERPRES at the Asterisk CLI. |
| `agi_callingani2` | 0 | The caller ANI2 associated with agi\_channel. |
| `agi_callington` | 0 | The caller ID TON \(Type of Number\) associated with agi\_channel. |
| `agi_callingtns` | 0 | The dialed number TNS \(Transit Network Select\) associated with agi\_channel. |
| `agi_dnid` | 7010 | The dialed number associated with agi\_channel. |
| `agi_rdnis` | unknown | The redirecting number associated with agi\_channel. |
| `agi_context` | phones | The context of the dialplan that agi\_channel was in when it executed the AGI\(\) or EAGI\(\) application. |
| `agi_extension` | 500 | The extension in the dialplan that agi\_channel was executing when it ran the AGI\(\) or EAGI\(\) application. |
| `agi_priority` | 1 | The priority of agi\_extension in agi\_context that executed AGI\(\) or EAGI\(\). |
| `agi_enhanced` | 0.0 | An indication of whether AGI\(\) or EAGI\(\) was used from the dialplan. 0.0 indicates that AGI\(\) was used. 1.0 indicates that EAGI() was used. |
| `agi_accountcode` | myaccount | The accountcode associated with agi\_channel. |
| `agi_threadid` | 140071216785168 | The threadid of the thread in Asterisk that is running the AGI\(\) or EAGI\(\) application. This may be useful for associating logs generated by the AGI application with logs generated by Asterisk, since the Asterisk logs contain thread IDs. |
| `agi_arg_<argument number>` | my argument | These variables provide the contents of the additional arguments provided to the AGI\(\) or EAGI() application. |

For an example of the variables that might be sent to an AGI application, see the AGI communication debug output in [“Quick Start”](18.%20Asterisk%20Gateway%20Interface%20-%20Asterisk%20%20The%20Definitive%20Guide,%205th%20Edition.htm%22%20/l%20%22AGI-quickstart). The end of the list of variables will be indicated by a blank line. The code handles these variables by reading lines of input in a loop until a blank line is received. At that point, the application continues and begins executing AGI commands.

#### Async AGI

When you use async AGI, Asterisk will send out a manager event called AsyncAGI to initiate the async AGI session. This event will allow applications listening to manager events to take over control of the call via the AGI manager action. Here is an example manager event sent out by Asterisk:

```
Event: AsyncAGI
Privilege: agi,all
SubEvent: Start
Channel: SIP/0000FFFF0001-00000000
Env: agi_request%3A%20async%0Aagi\_channel%3A%20SIP%2F0000FFFF0001-00000000%0A \

 agi\_language%3A%20en%0Aagi\_type%3A%20SIP%0A \

 agi\_uniqueid%3A%201285219743.0%0A \

 agi\_version%3A%201.8.0-beta5%0Aagi\_callerid%3A%2012565551111%0A \

 agi\_calleridname%3A%20Julie%20Bryant%0Aagi\_callingpres%3A%200%0A \

 agi\_callingani2%3A%200%0Aagi\_callington%3A%200%0Aagi\_callingtns%3A%200%0A \

 agi\_dnid%3A%20111%0Aagi\_rdnis%3A%20unknown%0Aagi\_context%3A%20LocalSets%0A \

 agi\_extension%3A%20111%0Aagi\_priority%3A%201%0Aagi\_enhanced%3A%200.0%0A \

 agi\_accountcode%3A%20%0Aagi\_threadid%3A%20-1339524208%0A%0A
```

**Примечание**

The value of the Env header in this AsyncAGI manager event is all on one line. The long value of the Env header has been URI encoded.

### Commands and Responses

Once an AGI session has been set up, Asterisk begins performing call processing in response to commands sent from the AGI application. As soon as an AGI command has been issued to Asterisk, no further commands will be processed on that channel until the current command has been completed. When it finishes processing a command, Asterisk will respond with the result.

**Примечание**

The AGI processes commands in a serial manner. Once a command has been executed, no further commands can be executed until Asterisk has returned a response. Some commands can take a very long time to execute. For example, the EXEC AGI command executes an Asterisk application. If the command is EXEC Dial, AGI communication is blocked until the call is done. If your AGI application needs to interact further with Asterisk at this point, it can do so using the AMI, which is covered in [Chapter 17](https://learning.oreilly.com/library/view/asterisk-the-definitive/9781492031598/ch17.html%22%20/l%20%22asterisk-AMI).

You can retrieve a full list of available AGI commands from the Asterisk console by running the command agi show commands. These commands are described in [Table 18-2](18.%20Asterisk%20Gateway%20Interface%20-%20Asterisk%20%20The%20Definitive%20Guide,%205th%20Edition.htm%22%20/l%20%22AGI-commands-table). To get more detailed information on a specific AGI command, including syntax information for any arguments that a command expects, use agi show commands topic COMMAND. For example, to see the built-in documentation for the ANSWER AGI command, you would use agi show commands topic ANSWER.

Таблица 18-2. Команды AGI

<table>
  <thead>
    <tr>
      <th style="text-align:left">AGI command</th>
      <th style="text-align:left">Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align:left">ANSWER</td>
      <td style="text-align:left">Answer the incoming call.</td>
    </tr>
    <tr>
      <td style="text-align:left">ASYNCAGI BREAK</td>
      <td style="text-align:left">End an async AGI session and have the channel return to the Asterisk dialplan.</td>
    </tr>
    <tr>
      <td style="text-align:left">CHANNEL STATUS</td>
      <td style="text-align:left">Retrieve the status of the channel. This is used to retrieve the current
        state of the channel, such as up (answered), down (hung up), or ringing.</td>
    </tr>
    <tr>
      <td style="text-align:left">DATABASE DEL</td>
      <td style="text-align:left">Delete a key/value pair from the built-in AstDB.</td>
    </tr>
    <tr>
      <td style="text-align:left">DATABASE DELTREE</td>
      <td style="text-align:left">Delete a tree of key/value pairs from the built-in AstDB.</td>
    </tr>
    <tr>
      <td style="text-align:left">DATABASE GET</td>
      <td style="text-align:left">Retrieve the value for a key in the AstDB.</td>
    </tr>
    <tr>
      <td style="text-align:left">DATABASE PUT</td>
      <td style="text-align:left">Set the value for a key in the AstDB.</td>
    </tr>
    <tr>
      <td style="text-align:left">EXEC</td>
      <td style="text-align:left">Execute an Asterisk dialplan application on the channel. This command
        is very powerful in that between EXEC and GET FULL VARIABLE, you can do
        anything with the call that you can do from the Asterisk dialplan.</td>
    </tr>
    <tr>
      <td style="text-align:left">GET DATA</td>
      <td style="text-align:left">Read digits from the caller.</td>
    </tr>
    <tr>
      <td style="text-align:left">GET FULL VARIABLE</td>
      <td style="text-align:left">Evaluate an Asterisk dialplan expression. You can send a string that contains
        variables and/or dialplan functions, and Asterisk will return the result
        after making the appropriate substitutions. This command is very powerful
        in that between EXEC and GET FULL VARIABLE, you can do anything with the
        call that you can do from the Asterisk dialplan.</td>
    </tr>
    <tr>
      <td style="text-align:left">GET OPTION</td>
      <td style="text-align:left">Stream a sound file while waiting for a digit from the caller. This is
        similar to the Background() dialplan application.</td>
    </tr>
    <tr>
      <td style="text-align:left">GET VARIABLE</td>
      <td style="text-align:left">Retrieve the value of a channel variable.</td>
    </tr>
    <tr>
      <td style="text-align:left">HANGUP</td>
      <td style="text-align:left">Hang up the channel.<a href="https://learning.oreilly.com/library/view/asterisk-the-definitive/9781492031598/ch18.html%22%20/l%20%22idm46178404238808">a</a>
      </td>
    </tr>
    <tr>
      <td style="text-align:left">NOOP</td>
      <td style="text-align:left">Do nothing. You will get a result response from this command, just like
        any other. It can be used as a simple test of the communication path with
        Asterisk.</td>
    </tr>
    <tr>
      <td style="text-align:left">RECEIVE CHAR</td>
      <td style="text-align:left">Receive a single character. This only works for channel types that support
        it, such as IAX2 using TEXT frames or SIP using the MESSAGE method.</td>
    </tr>
    <tr>
      <td style="text-align:left">RECEIVE TEXT</td>
      <td style="text-align:left">Receive a text message. This only works in the same cases as RECEIVE CHAR.</td>
    </tr>
    <tr>
      <td style="text-align:left">RECORD FILE</td>
      <td style="text-align:left">Record the audio from the caller to a file. This is a blocking operation
        similar to the Record() dialplan application. To record a call in the background
        while you perform other operations, use EXEC Monitor or EXEC MixMonitor.</td>
    </tr>
    <tr>
      <td style="text-align:left">SAY ALPHA</td>
      <td style="text-align:left">Say a string of characters. You can find an example of this in <a href="18.%20Asterisk%20Gateway%20Interface%20-%20Asterisk%20%20The%20Definitive%20Guide,%205th%20Edition.htm%22%20/l%20%22AGI-quickstart">&#x201C;Quick Start&#x201D;</a>.
        To get localized handling of this and the other SAY commands, set the channel
        language either in the device configuration file (e.g., sip.conf) or in
        the dialplan, by setting the CHANNEL(language) dialplan function.</td>
    </tr>
    <tr>
      <td style="text-align:left">SAY DIGITS</td>
      <td style="text-align:left">Say a string of digits. For example, 100 would be said as &#x201C;one
        zero zero&#x201D; if the channel&#x2019;s language is set to English.</td>
    </tr>
    <tr>
      <td style="text-align:left">SAY NUMBER</td>
      <td style="text-align:left">Say a number. For example, 100 would be said as &#x201C;one hundred&#x201D;
        if the channel&#x2019;s language is set to English.</td>
    </tr>
    <tr>
      <td style="text-align:left">SAY PHONETIC</td>
      <td style="text-align:left">Say a string of characters, but use a common word for each letter (Alpha,
        Bravo, Charlie&#x2026;).</td>
    </tr>
    <tr>
      <td style="text-align:left">SAY DATE</td>
      <td style="text-align:left">Say a given date.</td>
    </tr>
    <tr>
      <td style="text-align:left">SAY TIME</td>
      <td style="text-align:left">Say a given time.</td>
    </tr>
    <tr>
      <td style="text-align:left">SAY DATETIME</td>
      <td style="text-align:left">Say a given date and time using a specified format.</td>
    </tr>
    <tr>
      <td style="text-align:left">SEND IMAGE</td>
      <td style="text-align:left">Send an image to a channel. IAX2 supports this, but there are no actively
        developed IAX2 clients that support it that we know of.</td>
    </tr>
    <tr>
      <td style="text-align:left">SEND TEXT</td>
      <td style="text-align:left">Send text to a channel that supports it. This can be used with SIP and
        IAX2 channels, at least.</td>
    </tr>
    <tr>
      <td style="text-align:left">SET AUTOHANGUP</td>
      <td style="text-align:left">Schedule the channel to be hung up at a specified point in time in the
        future.</td>
    </tr>
    <tr>
      <td style="text-align:left">SET CALLERID</td>
      <td style="text-align:left">Set the caller ID name and number on the channel.</td>
    </tr>
    <tr>
      <td style="text-align:left">SET CONTEXT</td>
      <td style="text-align:left">Set the current dialplan context on the channel.</td>
    </tr>
    <tr>
      <td style="text-align:left">SET EXTENSION</td>
      <td style="text-align:left">Set the current dialplan extension on the channel.</td>
    </tr>
    <tr>
      <td style="text-align:left">SET MUSIC</td>
      <td style="text-align:left">Start or stop music on hold on the channel.</td>
    </tr>
    <tr>
      <td style="text-align:left">SET PRIORITY</td>
      <td style="text-align:left">Set the current dialplan priority on the channel.</td>
    </tr>
    <tr>
      <td style="text-align:left">SET VARIABLE</td>
      <td style="text-align:left">Set a channel variable to a given value.</td>
    </tr>
    <tr>
      <td style="text-align:left">STREAM FILE</td>
      <td style="text-align:left">Stream the contents of a file to a channel.</td>
    </tr>
    <tr>
      <td style="text-align:left">CONTROL STREAM FILE</td>
      <td style="text-align:left">Stream the contents of a file to a channel, but also allow the channel
        to control the stream. For example, the channel can pause, rewind, or fast-forward
        the stream.</td>
    </tr>
    <tr>
      <td style="text-align:left">TDD MODE</td>
      <td style="text-align:left">Toggle the TDD (Telecommunications Device for the Deaf) mode on the channel.</td>
    </tr>
    <tr>
      <td style="text-align:left">VERBOSE</td>
      <td style="text-align:left">Send a message to the verbose logger channel. Verbose messages show up
        on the Asterisk console if the verbose setting is high enough. Verbose
        messages will also go to any logfile that has been configured for the verbose
        logger channel in /etc/asterisk/logger.conf.</td>
    </tr>
    <tr>
      <td style="text-align:left">WAIT FOR DIGIT</td>
      <td style="text-align:left">Wait for the caller to press a digit.</td>
    </tr>
    <tr>
      <td style="text-align:left">SPEECH CREATE</td>
      <td style="text-align:left">Initialize speech recognition. This must be done before using other speech
        AGI commands.<a href="https://learning.oreilly.com/library/view/asterisk-the-definitive/9781492031598/ch18.html%22%20/l%20%22idm46178404204824">b</a>
      </td>
    </tr>
    <tr>
      <td style="text-align:left">SPEECH SET</td>
      <td style="text-align:left">Set a speech engine setting. The settings that are available are specific
        to the speech recognition engine in use.</td>
    </tr>
    <tr>
      <td style="text-align:left">SPEECH DESTROY</td>
      <td style="text-align:left">Destroy resources that were allocated for doing speech recognition. This
        command should be the last speech command executed.</td>
    </tr>
    <tr>
      <td style="text-align:left">SPEECH LOAD GRAMMAR</td>
      <td style="text-align:left">Load a grammar.</td>
    </tr>
    <tr>
      <td style="text-align:left">SPEECH UNLOAD GRAMMAR</td>
      <td style="text-align:left">Unload a grammar.</td>
    </tr>
    <tr>
      <td style="text-align:left">SPEECH ACTIVATE GRAMMAR</td>
      <td style="text-align:left">Activate a grammar that has been loaded.</td>
    </tr>
    <tr>
      <td style="text-align:left">SPEECH DEACTIVATE GRAMMAR</td>
      <td style="text-align:left">Deactivate a grammar.</td>
    </tr>
    <tr>
      <td style="text-align:left">SPEECH RECOGNIZE</td>
      <td style="text-align:left">Play a prompt and perform speech recognition, as well as wait for digits
        to be pressed.</td>
    </tr>
    <tr>
      <td style="text-align:left">GOSUB</td>
      <td style="text-align:left">Execute a dialplan subroutine. This will perform in the same way as the
        GoSub() dialplan application.</td>
    </tr>
    <tr>
      <td style="text-align:left">
        <p><a href="https://learning.oreilly.com/library/view/asterisk-the-definitive/9781492031598/ch18.html%22%20/l%20%22idm46178404238808-marker">a</a> When
          the HANGUP AGI command is used, the channel is not immediately hung up.
          Instead, the channel is marked as needing to be hung up. Your AGI application
          must exit first before Asterisk will continue and perform the actual hangup
          process.</p>
        <p><a href="https://learning.oreilly.com/library/view/asterisk-the-definitive/9781492031598/ch18.html%22%20/l%20%22idm46178404204824-marker">b</a> While
          Asterisk includes a core API for handling speech recognition, it does not
          come with a module that provides a speech recognition engine. Digium currently
          provides two commercial options for speech recognition: <a href="https://www.lumenvox.com/">Lumenvox</a> and
          <a
          href="http://www.digium.com/en/products/software/vestec.php">Vestec</a>.</p>
      </td>
      <td style="text-align:left"></td>
    </tr>
  </tbody>
</table>#### Process-based AGI/FastAGI

AGI commands are sent to Asterisk on a single line. The line must end with a single newline character. Once a command has been sent to Asterisk, no further commands will be processed until the last command has finished and a response has been sent back to the AGI application. Here is an example response to an AGI command:

200 result=0

**Подсказка**

The Asterisk console allows debugging the communications with an AGI application. To enable AGI communication debugging, run the agi set debug on command. To turn debugging off, use agi set debug off. While this debugging mode is on, all communication to and from an AGI application will be printed out to the Asterisk console. An example of this output can be found in [“Quick Start”](18.%20Asterisk%20Gateway%20Interface%20-%20Asterisk%20%20The%20Definitive%20Guide,%205th%20Edition.htm%22%20/l%20%22AGI-quickstart).

#### Async AGI

When you’re using async AGI, you issue commands by using the AGI manager action. To see the built-in documentation for the AGI manager action, run manager show command AGI at the Asterisk CLI. A demonstration will help clarify how AGI commands are executed using the async AGI method. First, an extension is created in the dialplan that runs an async AGI session on a channel:

```
exten => 240,AGI(agi:async)
```

When the AGI dialplan application is executed, a manager event called AsyncAGI will be sent out with all the AGI environment variables. Details about this event are in [“Async AGI”](18.%20Asterisk%20Gateway%20Interface%20-%20Asterisk%20%20The%20Definitive%20Guide,%205th%20Edition.htm%22%20/l%20%22AGI_id268960). After this, AGI manager actions can start to take place via AMI.

The following shows an example manager-action execution and the manager events that are emitted during async AGI processing. After the initial execution of the AGI manager action, there is an immediate response to indicate that the command has been queued up for execution. Later, there is a manager event that indicates that the queued command has been executed. The CommandID header can be used to associate the initial request with the event that indicates that the command has been executed:

```
Action: AGI
Channel: SIP/0004F2060EB4-00000013
ActionID: my-action-id
CommandID: my-command-id
Command: VERBOSE "Puppies like cotton candy." 1
Response: Success
ActionID: my-action-id
Message: Added AGI command to queue
Event: AsyncAGI
Privilege: agi,all
SubEvent: Exec
Channel: SIP/0004F2060EB4-00000013
CommandID: my-command-id
Result: 200%20result%3D1%0A
```

The following output is what was seen on the Asterisk console during this async AGI session:

```
 -- Executing [7011@phones:1] AGI("SIP/0004F2060EB4-00000013",
 "agi:async"\) in new stack
 agi:async: Puppies like cotton candy.
 == Spawn extension \(phones, 7011, 1\)
exited non-zero on 'SIP/0004F2060EB4-00000013'
```

### Ending an AGI Session

An AGI session ends when your AGI application is ready for it to end. The details about how this happens depend on whether your application is using process-based AGI, FastAGI, or async AGI.

#### Process-based AGI/FastAGI

Your AGI application may exit or close its connection at any time. As long as the channel has not hung up before your application ends, dialplan execution will continue.

If channel hangup occurs while your AGI session is still active, Asterisk will provide notification that this has occurred so that your application can adjust its operation as appropriate.

If a channel hangs up while your AGI application is still executing, a couple of things will happen. If an AGI command is in the middle of executing, you may receive a result code of -1. You should not depend on this, though, since not all AGI commands require channel interaction. If the command being executed does not require channel interaction, the result will not reflect the hangup.

The next thing that happens after a channel hangs up is that an explicit notification of the hangup is sent to your application. For process-based AGI, the signal SIGHUP will be sent to the process to notify it of the hangup. For a FastAGI connection, Asterisk will send a line containing the word HANGUP.

If you would like to disable having Asterisk send the SIGHUP signal to your process-based AGI application or the HANGUP string to your FastAGI server, you can do so by setting the AGISIGHUP channel variable, as demonstrated in this short example:

```
; no SIGHUP (AGI) or HANGUP (FastAGI)
exten => 237,1,Set(AGISIGHUP=no)
 same =&gt; n,AGI(hello-world.sh)
```

Once the hangup has happened, the only AGI commands that may be used are those that do not require channel interaction. The documentation for the AGI commands built into Asterisk includes an indication of whether or not each command can be used once the channel has been hung up.

#### Async AGI

When you’re using async AGI, the manager interface provides mechanisms to notify you about channel hangups. When you would like to end an async AGI session for a channel, you must execute the ASYNCAGI BREAK command. When the async AGI session ends, Asterisk will send an AsyncAGI manager event with a SubEvent of End. The following is an example of ending an async AGI session:

Action: AGI

Channel: SIP/0004F2060EB4-0000001b

ActionID: my-action-id

CommandID: my-command-id

Command: ASYNCAGI BREAK

Response: Success

ActionID: my-action-id

Message: Added AGI command to queue

Event: AsyncAGI

Privilege: agi,all

SubEvent: End

Channel: SIP/0004F2060EB4-0000001b

At this point, the channel returns to the next step in the Asterisk dialplan \(assuming it has not yet been hung up\).

## Example: Account Database Access

[Example 18-1](18.%20Asterisk%20Gateway%20Interface%20-%20Asterisk%20%20The%20Definitive%20Guide,%205th%20Edition.htm%22%20/l%20%22agiexample1) is an example of an AGI script. To run this script you would first place it in the /var/lib/asterisk/agi-bin directory. Then you would execute it from the Asterisk dialplan like this:

exten =&gt; 241,1,AGI\(account-lookup.py\)

 same =&gt; n,Hangup\(\)

This example is written in Python and is very sparsely documented for brevity. It demonstrates how an AGI script interfaces with Asterisk using stdin and stdout.

The script prompts a user to enter an account number, and then plays back a value associated with that number. In the interest of brevity, we have hardcoded a few fake accounts into the script—this would obviously be something normally handled by a database connection.

The script is intentionally terse, since we are interested in briefly showing some AGI functions without filling this book with pages of code.

**Example 18-1. account-lookup.py**

\#!/usr/bin/env python

\# An example for AGI \(Asterisk Gateway Interface\).

import sys

def agi\_command\(cmd\):

 '''Write out the command and return the response'''

 print cmd

 sys.stdout.flush\(\) \#clear the buffer

 return sys.stdin.readline\(\).strip\(\) \# strip whitespace

asterisk\_env = {} \# read AGI env vars from Asterisk

while True:

 line = sys.stdin.readline\(\).strip\(\)

 if not len\(line\):

 break

 var\_name, var\_value = line.split\(':', 1\)

 asterisk\_env\[var\_name\] = var\_value

\# Fake "database" of accounts.

ACCOUNTS = {

 '12345678': {'balance': '50'},

 '11223344': {'balance': '10'},

 '87654321': {'balance': '100'},

}

response = agi\_command\('ANSWER'\)

\# three arguments: prompt, timeout, maxlength

response = agi\_command\('GET DATA enter\_account 3000 8'\)

if 'timeout' in response:

 response = agi\_command\('STREAM FILE goodbye ""'\)

 sys.exit\(0\)

\# The response will look like: 200 result=&lt;digits&gt;

\# Split on '=', we want index 1

account = response.split\('=', 1\)\[1\]

if account == '-1': \# digits if error

 response = agi\_command\('STREAM FILE astcc-account-number-invalid ""'\)

 response = agi\_command\('HANGUP'\)

 sys.exit\(0\)

if account not in ACCOUNTS: \# invalid

 response = agi\_command\('STREAM FILE astcc-account-number-invalid ""'\)

 sys.exit\(0\)

balance = ACCOUNTS\[account\]\['balance'\]

response = agi\_command\('STREAM FILE account-balance-is ""'\)

response = agi\_command\('SAY NUMBER %s ""' % \(balance\)\)

sys.exit\(0\)

## Development Frameworks

There have been a number of efforts to create frameworks or libraries that make AGI programming easier. You will notice that several of these frameworks also appeared in [Chapter 17](https://learning.oreilly.com/library/view/asterisk-the-definitive/9781492031598/ch17.html%22%20/l%20%22asterisk-AMI). Just as with AMI, when evaluating a framework, we recommend you find one that meets the following criteria:

Maturity

Has this project been around for a few years? A mature project is far less likely to have serious bugs in it.

Maintenance

Check the age of the latest update. If the project hasn’t been updated in a few years, there’s a strong possibility it has been abandoned. It might still be usable, but you’ll be on your own. Similarly, what does the bug tracker look like? Are there a lot of important bugs being ignored? \(Be discerning here, since often the realities of maintaining a free project require disciplined triage—not everybody’s features are going to get added.\)

Quality of the code

Is this a well-written framework? If it was not engineered well, you should be aware of that when deciding whether to trust your project to it.

Community

Is there an active community of developers using this project? It’s likely you’ll need help; will it be available when you need it?

Documentation

The code should be well commented, but ideally, a wiki or other official documentation to support the library is essential.

The frameworks listed in [Table 18-3](18.%20Asterisk%20Gateway%20Interface%20-%20Asterisk%20%20The%20Definitive%20Guide,%205th%20Edition.htm%22%20/l%20%22AGI-frameworks) met all or most of the preceding criteria at this writing. If you do not see a library listed here for your preferred programming language, it might be out there somewhere, but simply didn’t make our list.

Table 18-3. AGI development frameworks

| Framework | Language |
| :--- | :--- |
| Adhearsion | Ruby |
| Asterisk-Java | Java |
| AsterNET | .NET |
| ding-dong | Node.js |
| PAGI | PHP |
| Panoramisk | Python |
| StarPy | Python + Twisted |

## Conclusion

AGI provides a powerful interface to Asterisk that allows you to implement first-party call control in the programming language of your choice. You can take multiple approaches to implementing an AGI application. Some approaches can provide better performance, but at the cost of more complexity. AGI provides a programming environment that may make it easier to integrate Asterisk with other systems, or just provide a more comfortable call-control programming environment for the experienced programmer. In many cases, the use of a prebuilt framework will be the best approach, especially when evaluating or prototyping a complex project. For the ultimate performance, we still recommend you consider writing as much of your application as you can using the Asterisk dialplan.

[Глава 17. AMI и файлы вызовов](glava-17.md) | [Содержание](SUMMARY.md) | [Глава 19. Asterisk REST Interface](glava-19.md)
